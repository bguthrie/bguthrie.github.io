<!DOCTYPE html>
<html lang="{{ .Site.LanguageCode | default "en" }}" class="scroll-smooth">
<head>
  {{ partial "head.html" . }}
  <script>
    // Check for dark mode preference
    if (localStorage.theme === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
      document.documentElement.classList.add('dark')
    } else {
      document.documentElement.classList.remove('dark')
    }
  </script>
</head>
<body class="bg-white dark:bg-gray-900 text-slate dark:text-gray-100 font-sans min-h-screen transition-colors">
  {{ partial "header.html" . }}
  {{ block "main" . }}{{ end }}
  {{ partial "footer.html" . }}
  <script>
    document.querySelectorAll('.theme-toggle').forEach(function(btn) {
      btn.addEventListener('click', function() {
        if (document.documentElement.classList.contains('dark')) {
          document.documentElement.classList.remove('dark');
          localStorage.theme = 'light';
        } else {
          document.documentElement.classList.add('dark');
          localStorage.theme = 'dark';
        }
      });
    });

    // TOC scroll highlighting
    (function() {
      var toc = document.getElementById('TableOfContents');
      if (!toc) return;

      var headings = document.querySelectorAll('h2[id], h3[id], h4[id]');
      if (!headings.length) return;

      var tocLinks = toc.querySelectorAll('a');
      var headingIds = Array.from(headings).map(function(h) { return h.id; });

      var observer = new IntersectionObserver(function(entries) {
        entries.forEach(function(entry) {
          if (entry.isIntersecting) {
            tocLinks.forEach(function(link) { link.classList.remove('active'); });
            var activeLink = toc.querySelector('a[href="#' + entry.target.id + '"]');
            if (activeLink) activeLink.classList.add('active');
          }
        });
      }, { rootMargin: '0px 0px -80% 0px', threshold: 0 });

      headings.forEach(function(heading) {
        if (headingIds.includes(heading.id)) observer.observe(heading);
      });
    })();
  </script>
</body>
</html>
