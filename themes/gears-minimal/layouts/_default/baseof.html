<!DOCTYPE html>
<html lang="{{ .Site.LanguageCode | default "en" }}" class="scroll-smooth">
<head>
  {{ partial "head.html" . }}
  <script>
    // Check for dark mode preference
    if (localStorage.theme === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
      document.documentElement.classList.add('dark')
    } else {
      document.documentElement.classList.remove('dark')
    }
  </script>
</head>
<body class="bg-white dark:bg-gray-900 text-slate dark:text-gray-100 font-sans min-h-screen transition-colors">
  {{ partial "header.html" . }}
  {{ block "main" . }}{{ end }}
  {{ partial "footer.html" . }}
  <script>
    document.querySelectorAll('.theme-toggle').forEach(function(btn) {
      btn.addEventListener('click', function() {
        if (document.documentElement.classList.contains('dark')) {
          document.documentElement.classList.remove('dark');
          localStorage.theme = 'light';
        } else {
          document.documentElement.classList.add('dark');
          localStorage.theme = 'dark';
        }
      });
    });

    // TOC scroll highlighting
    (function() {
      var tocContainer = document.querySelector('.toc');
      if (!tocContainer) return;

      var toc = document.getElementById('TableOfContents');
      var titleLink = tocContainer.querySelector('.toc-title');
      var headings = document.querySelectorAll('h2[id], h3[id], h4[id]');
      if (!headings.length) return;

      var allLinks = tocContainer.querySelectorAll('a');

      function clearActive() {
        allLinks.forEach(function(link) { link.classList.remove('active'); });
      }

      var observer = new IntersectionObserver(function(entries) {
        entries.forEach(function(entry) {
          if (entry.isIntersecting) {
            clearActive();
            var activeLink = toc.querySelector('a[href="#' + entry.target.id + '"]');
            if (activeLink) activeLink.classList.add('active');
          }
        });
      }, { rootMargin: '0px 0px -80% 0px', threshold: 0 });

      headings.forEach(function(heading) { observer.observe(heading); });

      // Highlight title when scrolled to top
      window.addEventListener('scroll', function() {
        if (window.scrollY < 100 && titleLink) {
          clearActive();
          titleLink.classList.add('active');
        }
      });
    })();
  </script>
</body>
</html>
