<!DOCTYPE html>
<html lang="{{ .Site.LanguageCode | default "en" }}" class="scroll-smooth">
<head>
  {{ partial "head.html" . }}
  <script>
    // Theme: system (no localStorage) | light | dark
    (function() {
      var theme = localStorage.theme;
      var prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;

      if (theme === 'dark' || (!theme && prefersDark)) {
        document.documentElement.classList.add('dark');
      } else {
        document.documentElement.classList.remove('dark');
      }
    })();
  </script>
</head>
<body class="bg-white dark:bg-gray-900 text-slate dark:text-gray-100 font-sans min-h-screen transition-colors">
  {{ partial "header.html" . }}
  {{ block "main" . }}{{ end }}
  {{ partial "footer.html" . }}
  <script>
    // Theme toggle: system → light → dark → system
    (function() {
      var prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;

      function getTheme() {
        return localStorage.theme || 'system';
      }

      function applyTheme(theme) {
        if (theme === 'dark' || (theme === 'system' && prefersDark)) {
          document.documentElement.classList.add('dark');
        } else {
          document.documentElement.classList.remove('dark');
        }
      }

      function updateIcons(theme) {
        var titles = { system: 'Theme: System', light: 'Theme: Light', dark: 'Theme: Dark' };
        document.querySelectorAll('.theme-icon-system, .theme-icon-light, .theme-icon-dark').forEach(function(icon) {
          icon.classList.add('hidden');
        });
        document.querySelectorAll('.theme-icon-' + theme).forEach(function(icon) {
          icon.classList.remove('hidden');
        });
        document.querySelectorAll('.theme-toggle').forEach(function(btn) {
          btn.title = titles[theme];
        });
      }

      function cycleTheme() {
        var current = getTheme();
        var next;
        if (current === 'system') next = 'light';
        else if (current === 'light') next = 'dark';
        else next = 'system';

        if (next === 'system') {
          delete localStorage.theme;
        } else {
          localStorage.theme = next;
        }

        applyTheme(next);
        updateIcons(next);
      }

      // Initialize icons
      updateIcons(getTheme());

      // Attach click handlers
      document.querySelectorAll('.theme-toggle').forEach(function(btn) {
        btn.addEventListener('click', cycleTheme);
      });
    })();

    // TOC scroll highlighting
    (function() {
      var tocContainer = document.querySelector('.toc');
      if (!tocContainer) return;

      var toc = document.getElementById('TableOfContents');
      var titleLink = tocContainer.querySelector('.toc-title');
      var headings = document.querySelectorAll('h2[id], h3[id], h4[id]');
      if (!headings.length) return;

      var allLinks = tocContainer.querySelectorAll('a');

      function clearActive() {
        allLinks.forEach(function(link) { link.classList.remove('active'); });
      }

      var observer = new IntersectionObserver(function(entries) {
        entries.forEach(function(entry) {
          if (entry.isIntersecting) {
            clearActive();
            var activeLink = toc.querySelector('a[href="#' + entry.target.id + '"]');
            if (activeLink) activeLink.classList.add('active');
          }
        });
      }, { rootMargin: '0px 0px -80% 0px', threshold: 0 });

      headings.forEach(function(heading) { observer.observe(heading); });

      // Highlight title when scrolled to top
      window.addEventListener('scroll', function() {
        if (window.scrollY < 100 && titleLink) {
          clearActive();
          titleLink.classList.add('active');
        }
      });
    })();
  </script>
</body>
</html>
